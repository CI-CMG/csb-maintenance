{
  "Comment": "Update all modified CSB partitions",
  "StartAt": "get all partition records",
  "States": {
    "get all partition records": {
      "Type": "Task",
      "Arguments": {
        "TableName": "csb-dirty-partitions-test"
      },
      "Resource": "arn:aws:states:::aws-sdk:dynamodb:scan",
      "Next": "Foreach partition name",
      "Assign": {
        "inputPayload": "{% $states.context.Execution.Input %}",
        "dirtyPartitions": "{% [$states.result.Items.PK.S] %}"
      },
      "Output": "{% [$states.result.Items.PK.S] %}",
      "Catch": [
        {
          "ErrorEquals": [
            "States.ALL"
          ],
          "Next": "Send general failure notification"
        }
      ]
    },
    "Send general failure notification": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sns:publish",
      "Arguments": {
        "TopicArn": "arn:aws:sns:us-east-1:282856304593:csb-email",
        "Message": "{% 'Failed to re-create partitions' %}",
        "Subject": "Failure re-creating partitions"
      },
      "Next": "General Failure"
    },
    "Foreach partition name": {
      "Type": "Map",
      "ItemProcessor": {
        "ProcessorConfig": {
          "Mode": "INLINE"
        },
        "StartAt": "setup and validate",
        "States": {
          "setup and validate": {
            "Type": "Pass",
            "Next": "Drop Partition",
            "Assign": {
              "partitionName": "{% $states.input %}",
              "dropPartitionStmt": "{% 'ALTER TABLE ' & $states.context.Execution.Input.TableName & \" DROP IF EXISTS PARTITION (h3 = '\" & $states.input & \"')\" %}"
            },
            "Comment": "set variable for this iteration's partition name so each state w/in Map state will not have to pass it"
          },
          "Drop Partition": {
            "Type": "Task",
            "Resource": "arn:aws:states:::athena:startQueryExecution.sync",
            "Arguments": {
              "QueryString": "{% $dropPartitionStmt %}",
              "WorkGroup": "primary"
            },
            "Next": "Drop Partition Succeded?"
          },
          "Drop Partition Succeded?": {
            "Type": "Choice",
            "Choices": [
              {
                "Next": "Send failure notification",
                "Condition": "{% $states.input.QueryExecution.Status.State != 'SUCCEEDED'%}"
              }
            ],
            "Default": "Delete Parquet Objects",
            "Output": {
              "Status": "{% $states.input.QueryExecution.Status.State %}"
            }
          },
          "Send failure notification": {
            "Type": "Task",
            "Resource": "arn:aws:states:::sns:publish",
            "Arguments": {
              "TopicArn": "arn:aws:sns:us-east-1:282856304593:csb-email",
              "Message": "{% 'Error: unable to re-create partition ' & $partitionName %}",
              "Subject": "Error re-creating partition"
            },
            "Next": "Single Partition Failure"
          },
          "Single Partition Failure": {
            "Type": "Fail"
          },
          "Delete Parquet Objects": {
            "Type": "Task",
            "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
            "Arguments": {
              "FunctionName": "${DeletePartitionFilesFunction}",
              "Payload": {
                "partition": "{% $partitionName %}",
                "taskToken": "{% $states.context.Task.Token %}"
              }
            },
            "Retry": [
              {
                "ErrorEquals": [
                  "Lambda.ServiceException",
                  "Lambda.AWSLambdaException",
                  "Lambda.SdkClientException",
                  "Lambda.TooManyRequestsException"
                ],
                "IntervalSeconds": 1,
                "MaxAttempts": 3,
                "BackoffRate": 2,
                "JitterStrategy": "FULL"
              }
            ],
            "Next": "remove partition record"
          },
          "remove partition record": {
            "Type": "Task",
            "Resource": "arn:aws:states:::dynamodb:deleteItem",
            "Arguments": {
              "TableName": "csb-dirty-partitions-test",
              "Key": {
                "PK": {
                  "S": "{% $partitionName %}"
                }
              }
            },
            "Output": {
              "partition": "{% $partitionName %}"
            },
            "End": true
          }
        }
      },
      "Next": "Build Query String",
      "Catch": [
        {
          "ErrorEquals": [
            "States.ALL"
          ],
          "Comment": "error within a given partition update",
          "Next": "Send general failure notification"
        }
      ]
    },
    "Build Query String": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Output": "{% $states.result.Payload %}",
      "Arguments": {
        "FunctionName": "${BuildPartitionInsertQueryFunction}",
        "Payload": {
          "tablename": "{% $states.context.Execution.Input.TableName %}",
          "partitions": "{% $dirtyPartitions %}"
        }
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException",
            "Lambda.TooManyRequestsException"
          ],
          "IntervalSeconds": 1,
          "MaxAttempts": 3,
          "BackoffRate": 2,
          "JitterStrategy": "FULL"
        }
      ],
      "Next": "Re-populate affected partitions"
    },
    "Re-populate affected partitions": {
      "Type": "Task",
      "Resource": "arn:aws:states:::athena:startQueryExecution.sync",
      "Arguments": {
        "QueryString": "{% $states.input.query_string %}",
        "WorkGroup": "primary"
      },
      "Next": "Athena GetQueryResults",
      "Assign": {
        "TotalExecutionTimeInMillis": "{% $states.result.QueryExecution.Statistics.TotalExecutionTimeInMillis %}",
        "DataScannedInBytes": "{% $states.result.QueryExecution.Statistics.DataScannedInBytes %}"
      }
    },
    "Athena GetQueryResults": {
      "Type": "Task",
      "Resource": "arn:aws:states:::athena:getQueryResults",
      "Arguments": {
        "QueryExecutionId": "{% $states.input.QueryExecution.QueryExecutionId %}"
      },
      "Next": "Re-populate partitions succeeded?"
    },
    "Re-populate partitions succeeded?": {
      "Type": "Choice",
      "Choices": [
        {
          "Next": "Send general failure notification",
          "Condition": "{% $states.input.QueryExecution.Status.State != 'SUCCEEDED'%}"
        }
      ],
      "Default": "Send success notification"
    },
    "Send success notification": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sns:publish",
      "Arguments": {
        "TopicArn": "arn:aws:sns:us-east-1:282856304593:csb-email",
        "Message": "{% 'Successfully re-created ' & $count($dirtyPartitions) & ' partition(s).  Execution time was ' & ( $totalSeconds := $floor($TotalExecutionTimeInMillis / 1000);\n  $minutes := $floor($totalSeconds / 60); $seconds := $totalSeconds % 60; $formatNumber($minutes, '00') & ':' & $formatNumber($seconds, '00') &  '.' & $TotalExecutionTimeInMillis % 1000) & ' minutes.  ' & $round($DataScannedInBytes/1000000000, 2) & ' GB were scanned and ' & $states.input.UpdateCount & ' records were inserted into the ' & $inputPayload.TableName & ' table.' %}",
        "Subject": "Success re-creating partitions"
      },
      "Next": "Success"
    },
    "General Failure": {
      "Type": "Fail"
    },
    "Success": {
      "Type": "Succeed"
    }
  },
  "QueryLanguage": "JSONata"
}